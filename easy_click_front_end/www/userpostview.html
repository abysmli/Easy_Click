<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height" />
    <title>User Post</title>
    <link rel="stylesheet" href="resource/stylesheets/jquery.excoloSlider.css" />
    <link rel="stylesheet" href="resource/javascripts/jquery_mobile/jquery.mobile-1.4.0.min.css" />
    <link rel="stylesheet" href="resource/stylesheets/jquery.mobile.iscrollview.css" />
    <link rel="stylesheet" href="resource/stylesheets/jquery.mobile.iscrollview-pull.css" />
    <link rel="stylesheet" href="resource/stylesheets/main.css" />
    <script src="phonegap.js"></script>
    <script src="resource/javascripts/jquery-2.0.3.min.js"></script>
    <script src="resource/javascripts/jquery_mobile/jquery.mobile-1.4.0.min.js"></script>
    <script src="resource/javascripts/jquery.excoloSlider.js"></script>
    <script src="resource/javascripts/iscroll.js"></script>
    <script src="resource/javascripts/jquery.mobile.iscrollview.js"></script>
    <script src="resource/javascripts/main.js"></script>
</head>
<body>
    <div data-role="page" id="user_post_view_page" class="page_body" data-dom-cache="true">
        <div class="nav_bar">
            <a data-rel="back">
                <img alt="" src="resource/img/icon_img/icon_back.png"></img>
            </a>
            <a data-transition="flip" href="index.html">
                <img alt="" src="resource/img/icon_img/icon_home.png"></img>
            </a>
            <a data-transition="slide" href="post_selector.html">
                <img alt="" src="resource/img/icon_img/icon_write.png"></img>
            </a>
            <a data-transition="slide" href="aboutpost.html">
                <img alt="" src="resource/img/icon_img/icon_contact_us.png"></img>
            </a>
            <h3>交流</h3>
        </div>
        <div class="search_block">
            <form>
                <div class="ui-field-contain">
                    <select id="key_selector" onchange="changeSelector()" data-mini="true">
                        <option value="" selected="selected">全部分类</option>
                        <option value="A">数码 手机 电器 电脑 网络</option>
                        <option value="B">生活 交通 家具 日用 百货</option>
                        <option value="C">服装 鞋包 配饰 手表 小物 </option>
                        <option value="D">母婴 护理 彩妆 运动 户外</option>
                        <option value="E">美食 特产 文化 书籍 娱乐</option>
                    </select>
                </div>
            </form>
        </div>
        <div style="height:5.3em; display:block;" data-iscroll-fixed=""></div>
        <div data-iscroll="" data-role="content">
            <div class="iscroll-pulldown">
                <span class="iscroll-pull-icon"></span>
                <span class="iscroll-pull-label" data-iscroll-loading-text="载入中" data-iscroll-pulled-text="松开立即更新">下拉更新</span>
            </div>
            <div id="post_list" class="ui-grid-b">
            </div>
            <div class="iscroll-pullup">
                <span class="iscroll-pull-icon"></span>
                <span class="iscroll-pull-label" data-iscroll-loading-text="载入中" data-iscroll-pulled-text="松开立即加载">上拉加载更多</span>
            </div>
        </div>
        <div id="floatingCirclesG" class="userpostview_floatingBarsG">
            <div class="f_circleG" id="frotateG_01"></div>
            <div class="f_circleG" id="frotateG_02"></div>
            <div class="f_circleG" id="frotateG_03"></div>
            <div class="f_circleG" id="frotateG_04"></div>
            <div class="f_circleG" id="frotateG_05"></div>
            <div class="f_circleG" id="frotateG_06"></div>
            <div class="f_circleG" id="frotateG_07"></div>
            <div class="f_circleG" id="frotateG_08"></div>
        </div>
        <script>
            var listSelector = "#post_list",
                lastItemSelector = listSelector + " > div:last-child",
                pullUpflag=false;
                mSkip=15,
                mLimit=9,
                mKey=$('#search_input').val();

            $(document).one("pageinit","#user_post_view_page", function( event ) {
                $(".iscroll-wrapper", this).bind({
                    iscroll_onpulldown : onPullDown,
                    iscroll_onpullup   : onPullUp
                });
            });

            document.addEventListener("deviceready", onDeviceReady_userpostview, false);

            function onDeviceReady_userpostview() {
                $('#key_selector').html('').append(
                    "<option value='' selected='selected'>全部分类</option>"+
                    "<option value='A'>数码 手机 电器 电脑 网络</option>"+
                    "<option value='B'>生活 交通 家具 日用 百货</option>"+
                    "<option value='C'>服装 鞋包 配饰 手表 小物 </option>"+
                    "<option value='D'>母婴 护理 彩妆 运动 户外</option>"+
                    "<option value='E'>美食 特产 文化 书籍 娱乐</option>"
                );
                //$("#user_post_view_page .iscroll-scroller").css("padding-top","5.6em");
                $('#post_list').on('click', '.userpost_list a', function(){
                    sessionStorage.postuid = $(this).parent('div.userpost_list').attr('id');
                });
                $('#post_list').on('vmousedown','a',function(){
                    $(this).parent('div.userpost_list').css({opacity:0.5}).animate({opacity:1},200);
                });
                if(localStorage.UserPostCatagory) {
                    getLocalContent();
                }
                checkUpdate();
            }

            function changeSelector() {
                mKey=$('#key_selector').val();
                $('#post_list').html("");
                $('.userpostview_floatingBarsG').show();
                var data = {
                    tags: mKey,
                    skip: 0,
                    limit: 15
                };
                sendAjax('/app_user_post_view', data, function(posts){
                    if(posts!="") {
                        $.each(posts, insertUserPostCatagory);
                        $('.userpostview_floatingBarsG').hide();
                    } else {
                        $('#post_list').html("<p>该分类暂无内容</p>");
                        $('.userpostview_floatingBarsG').hide();
                    }
                    mSkip=15;
                    $(".iscroll-wrapper").iscrollview("refresh").iscrollview("scrollTo", 0, 50, false);
                },function(jqXHR, textStatus, errorThrown){
                    $('.userpostview_floatingBarsG').hide();
                    displayNetworkError('#user_post_view_page');
                    mSkip=15;
                });
            }

            function insertUserPostCatagory(key, post) {
                var imgstring="", classstring="";
                if (post.previmg.length==0){
                    imgstring = "resource/img/information_img/information_box.png";
                } else {
                    imgstring = "data:image/jpg;base64,"+post.previmg;
                }
                if(key % 3 ==0) {
                    classstring = "ui-block-a";
                } else if(key % 3 ==1) {
                    classstring = "ui-block-b";
                } else if(key % 3 ==2) {
                    classstring = "ui-block-c";
                }
                $('#post_list').append("<div class='"+classstring+"'>"+
                    "<div class='userpost_list' id='"+post.uid+"'>"+
                        "<a href='userpostview_details.html' data-transition='slide'>"+
                            "<img alt='img' src='"+imgstring+"'></img>"+
                            "<div>"+
                                "<p>"+post.prevtext+"</p>"+
                            "</div>"+
                        "</a>"+
                    "</div>"+
                "</div>");
            }

            function gotPullDownData(event, mIscroll) {
                if(mKey==undefined) {
                    mKey="";
                }
                var data =  {
                    tags: mKey,
                    skip: 0,
                    limit: 15
                };
                sendAjax('/app_user_post_view', data, function(posts){
                    if(posts!="") {
                        $('#post_list').html("");
                        $.each(posts, insertUserPostCatagory);
                        if(mKey=="")
                        {
                            localStorage.UserPostCatagory = JSON.stringify(posts);
                        }
                    } else {
                        $('#post_list').html("<p>该分类暂无内容</p>");
                    }
                    mIscroll.iscrollview.refresh();
                    mSkip=15;
                }, function(jqXHR, textStatus, errorThrown){
                    mIscroll.iscrollview.refresh();
                    displayNetworkError('#user_post_view_page');
                });
            }

            function gotPullUpData(event, mIscroll) {
                if(!pullUpflag) {
                    pullUpflag=true;
                    if(mKey==undefined) {
                        mKey="";
                    }
                    var data = {
                        tags: mKey,
                        skip: mSkip,
                        limit: mLimit
                    };
                    sendAjax('/app_user_post_view', data, function(posts){
                        mSkip+=mLimit;
                        $.each(posts, insertUserPostCatagory);
                        iscrollview = mIscroll.iscrollview,
                        iscrollview.refresh(null, null, $.proxy(function (iscrollview) { 
                            this.scrollToElement(lastItemSelector, 400); 
                        }, iscrollview) ); 
                        pullUpflag=false;
                    },function(jqXHR, textStatus, errorThrown){
                        pullUpflag=false;
                        mIscroll.iscrollview.refresh();
                        displayNetworkError('#user_post_view_page');
                    });
                }
            }
            function onPullDown (event, data) { 
                gotPullDownData(event, data); 
            }    

            function onPullUp (event, data) { 
                gotPullUpData(event, data); 
            }
            function checkUpdate() {
                /*
                sendAjax('/app_user_post_newst_list', "", function(remotelist){
                    var locallist=getLocalList();

                var array1=[1,2,3,4,7,9,10,13,15,16];
                var array2=[5,6,1,2,3,4,9,10,13,15];
                for(var i=array2.length-1;i>=0;--i)
                {
                    if(remotelist.indexOf(array2[i])<0) {
                        array1.unshift(array2[i]);
                    }
                }
                alert(array1);
                $.each(locallist, function(key, _locallist){
                    if(array2.indexOf(_array1)<0) {
                        array1.splice(key,1);
                    }
                });
                alert(array1);

                },function(jqXHR, textStatus, errorThrown){
                    $('.userpostview_floatingBarsG').hide();
                    displayNetworkError('#user_post_view_page');
                });*/

                var data = {
                    uid: ""
                };
                sendAjax('/app_user_post_newst_date', data, function(newst_date){
                    if(newst_date != localStorage.UserPostCatagoryCheckDate) {
                        getRemoteContent(newst_date);
                    }
                },function(jqXHR, textStatus, errorThrown){
                    $('.userpostview_floatingBarsG').hide();
                    displayNetworkError('#user_post_view_page');
                });
            }
            function getRemoteContent(newst_date) {
                $('.userpostview_floatingBarsG').show();
                var data = {
                    tags: "",
                    skip: 0,
                    limit: 15
                };
                sendAjax('/app_user_post_view', data, function(posts){
                    $('#post_list').html("");
                    $.each(posts, insertUserPostCatagory);
                    $(".iscroll-wrapper").iscrollview("refresh");
                    localStorage.UserPostCatagory = JSON.stringify(posts);
                    localStorage.UserPostCatagoryCheckDate = newst_date;
                    $('.userpostview_floatingBarsG').hide();
                },function(jqXHR, textStatus, errorThrown){
                    $('.userpostview_floatingBarsG').hide();
                    displayNetworkError('#user_post_view_page');
                });
            }
            function getLocalContent() {
                $('.userpostview_floatingBarsG').hide();
                $.each(posts, insertUserPostCatagory);
                $(".iscroll-wrapper").iscrollview("refresh");
            }
            function getLocalList() {
                var posts = JSON.parse(localStorage.UserPostCatagory);
                var postlist=[];
                $.each(posts,function(key, post){
                    postlist.push({uid: post.uid, date: post.date})
                });
                return postlist;
            }
        </script>
    </div>
</body>
</html>
