<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Information</title>
    <link rel="stylesheet" href="resource/stylesheets/jquery.excoloSlider.css" />
    <link rel="stylesheet" href="resource/javascripts/jquery_mobile/jquery.mobile-1.4.0.min.css" />
    <link rel="stylesheet" href="resource/stylesheets/jquery.mobile.iscrollview.css" />
    <link rel="stylesheet" href="resource/stylesheets/jquery.mobile.iscrollview-pull.css" />
    <link rel="stylesheet" href="resource/stylesheets/main.css" />
    <script src="resource/javascripts/jquery-2.0.3.min.js"></script>
    <script src="resource/javascripts/jquery_mobile/jquery.mobile-1.4.0.min.js"></script>
    <script src="resource/javascripts/jquery.excoloSlider.js"></script>
    <script src="resource/javascripts/iscroll.js"></script>
    <script src="resource/javascripts/jquery.mobile.iscrollview.js"></script>
    <script src="resource/javascripts/main.js"></script>
    <script src="phonegap.js"></script>
</head>
<body>
    <div data-role="page" id="information_catagory_page" class="page_body">
        <div class="nav_bar">
            <a data-rel="back">
                <img alt="" src="resource/img/icon_img/icon_back.png"></img>
            </a>
            <a data-transition="flip" href="index.html">
                <img alt="" src="resource/img/icon_img/icon_home.png"></img>
            </a>
            <a data-transition="slide" href="post_selector.html">
                <img alt="" src="resource/img/icon_img/icon_write.png"></img>
            </a>
            <a data-transition="slide" href="aboutpost.html">
                <img alt="" src="resource/img/icon_img/icon_contact_us.png"></img>
            </a>
            <h3>资讯</h3>
        </div>
        <div class="search_block">
            <form>
                <div class="ui-field-contain">
                    <select id="key_selector" data-mini="true">
                        <option value="" selected="selected">分类查找</option>
                        <option value="全部分类">全部分类</option>
                        <option value="家具">家具</option>
                        <option value="电器">电器</option>
                        <option value="服装">服装</option>
                        <option value="新品">新品</option>
                    </select>
                </div>
            </form>
        </div>
        <div data-iscroll="" data-role="content">
            <div class="iscroll-pulldown">
                <span class="iscroll-pull-icon"></span>
                <span class="iscroll-pull-label" data-iscroll-loading-text="载入中" data-iscroll-pulled-text="松开立即更新">下拉更新</span>
            </div>
            <div id="information_catagory" class="ui-grid-b"></div>
            <div class="iscroll-pullup">
                <span class="iscroll-pull-icon"></span>
                <span class="iscroll-pull-label" data-iscroll-loading-text="载入中" data-iscroll-pulled-text="松开立即加载">上拉加载更多</span>
            </div>
        </div>
        <div id="floatingCirclesG" class="information_catagory_floatingBarsG">
            <div class="f_circleG" id="frotateG_01"></div>
            <div class="f_circleG" id="frotateG_02"></div>
            <div class="f_circleG" id="frotateG_03"></div>
            <div class="f_circleG" id="frotateG_04"></div>
            <div class="f_circleG" id="frotateG_05"></div>
            <div class="f_circleG" id="frotateG_06"></div>
            <div class="f_circleG" id="frotateG_07"></div>
            <div class="f_circleG" id="frotateG_08"></div>
        </div>
        <script>
            var listSelector = "#information_catagorys",
                lastItemSelector = listSelector + " > div:last-child",
                pullUpflag=false;
                mSkip=15,
                mLimit=9,
                mKey=$('#search_input').val();
            $(document).one("pageinit","#information_catagory_page", function( event ) {
                $("#information_catagory_page .iscroll-scroller").css("padding-top","5.6em");
                $(".iscroll-wrapper", this).bind({
                    iscroll_onpulldown : onPullDown,
                    iscroll_onpullup   : onPullUp
                });
                onDeviceReady_information_catagory();
                $('#information_catagory').on('vmousedown','a',function(){
                    $(this).parent('div.information_list').css({opacity:0.5}).animate({opacity:1},200);
                });
            });
            function onDeviceReady_information_catagory(){
                $('.nav_bar h3').text(sessionStorage.title);
                
                if(sessionStorage.index=="find_job"){
                    $('#key_selector').html('').append(
                       "<option value='' selected='selected'>全部分类</option>"+
                       "<option value='中华料理 居酒屋 饮食店相关'>中华料理 居酒屋 饮食店相关</option>"+
                       "<option value='健康整体 治疗 足裹 オイル 美妆类'>健康整体 治疗 足裹 オイル 美妆类</option>"+
                       "<option value='清店 アロマ エステ 其它'>清店 アロマ エステ 其它</option>"+
                       "<option value='スナック クラブ パブ 其它'>スナック クラブ パブ 其它</option>"+
                       "<option value='清扫 司机 工厂 工地 工事类'>清扫 司机 工厂 工地 工事类</option>"+
                       "<option value='会社 营业 事务所 办公室类'>会社 营业 事务所 办公室类</option>"+
                       "<option value='计算机 网络 电子技术类'>计算机 网络 电子技术类</option>"+
                       "<option value='可就职 可办签证'>可就职 可办签证</option>"+
                       "<option value='找学员 培训'>找学员 培训</option>"+
                       "<option value='其它'>其它</option>"
                       );
                       
                    if(!localStorage.informationFindJobCatagory) {
                        var data =  {
                            index: sessionStorage.index,
                            tags: "",
                            skip: 0,
                            limit: 15
                        };
                        sendAjax('/app_information_catagory', data, function(shops){
                            $('.information_catagory_floatingBarsG').hide();
                            $.each(shops, insertInformationCatagory);
                            localStorage.informationFindJobCatagory = JSON.stringify(shops);
                        }, function(jqXHR, textStatus, errorThrown){
                            $('.information_catagory_floatingBarsG').hide();
                            showError('#information_catagory_page','网络错误！连接失败！ 请重试!');
                        });
                    } else {
                        var shops = JSON.parse(localStorage.informationFindJobCatagory);
                        $('.information_catagory_floatingBarsG').hide();
                        $.each(shops, insertInformationCatagory);
                    }
                } else if(sessionStorage.index=="find_house") {
                    $('#key_selector').html('').append(
                        "<option value='' selected='selected'>全部分类</option>"+
                        "<option value='寮'>寮</option>"+
                        "<option value='アパート'>アパート</option>"+
                        "<option value='マンション'>マンション</option>"+
                        "<option value='売却物件'>売却物件</option>"+
                        "<option value='其它'>其它</option>"
                    );

                    if(!localStorage.informationFindHouseCatagory) {
                        var data =  {
                            index: sessionStorage.index,
                            tags: "",
                            skip: 0,
                            limit: 15
                        };
                        sendAjax('/app_information_catagory', data, function(shops){
                            $('.information_catagory_floatingBarsG').hide();
                            $.each(shops, insertInformationCatagory);
                            localStorage.informationFindHouseCatagory = JSON.stringify(shops);
                        }, function(jqXHR, textStatus, errorThrown){
                            $('.information_catagory_floatingBarsG').hide();
                            showError('#information_catagory_page','网络错误！连接失败！ 请重试!');
                        });
                    } else {
                        var shops = JSON.parse(localStorage.informationFindHouseCatagory);
                        $('.information_catagory_floatingBarsG').hide();
                        $.each(shops, insertInformationCatagory);
                    }
                } else if(sessionStorage.index=="move_house") {
                    $('#key_selector').html('').append(
                        "<option value='' selected='selected'>全部分类</option>"
                        "<option value='大小搬家'>大小搬家</option>"+
                        "<option value='用车 包车 货运'>用车 包车 货运</option>"+
                        "<option value='深夜用车 24小时用车'>深夜用车 24小时用车</option>"+
                        "<option value='不用品处理 回收 新、中古贩卖'>不用品处理 回收 新、中古贩卖</option>"+
                        "<option value='空调拆装 维修 充ガス 贩卖'>空调拆装 维修 充ガス 贩卖</option>"+
                        "<option value='装修解体 地陪导游 翻译 其它业务'>装修解体 地陪导游 翻译 其它业务</option>"
                    );

                    if(!localStorage.informationMoveHouseCatagory) {
                        var data =  {
                            index: sessionStorage.index,
                            tags: "",
                            skip: 0,
                            limit: 15
                        };
                        sendAjax('/app_information_catagory', data, function(shops){
                            $('.information_catagory_floatingBarsG').hide();
                            $.each(shops, insertInformationCatagory);
                            localStorage.informationMoveHouseCatagory = JSON.stringify(shops);
                        }, function(jqXHR, textStatus, errorThrown){
                            $('.information_catagory_floatingBarsG').hide();
                            showError('#information_catagory_page','网络错误！连接失败！ 请重试!');
                        });
                    } else {
                        var shops = JSON.parse(localStorage.informationMoveHouseCatagory);
                        $('.information_catagory_floatingBarsG').hide();
                        $.each(shops, insertInformationCatagory);
                    }                   
                } else if(sessionStorage.index=="business") {
                    $('#key_selector').html('').append(
                        "<option value='' selected='selected'>全部分类</option>"+
                        "<option value='中国餐饮 KTV 美容美发 生活娱乐'>中国餐饮 KTV 美容美发 生活娱乐</option>"+
                        "<option value='各种店铺转让'>各种店铺转让</option>"+
                        "<option value='店铺用品相关'>店铺用品相关</option>"+
                        "<option value='广告印刷 看板网页 菜单制作等'>广告印刷 看板网页 菜单制作等</option>"+
                        "<option value='各种内外工事'>各种内外工事</option>"+
                        "<option value='婚介交友'>婚介交友</option>"+
                        "<option value='不动产'>不动产</option>"+
                        "<option value='保证人'>保证人</option>"+
                        "<option value='中国物产 中国商城 特价商品'>中国物产 中国商城 特价商品</option>"+
                        "<option value='电脑 网络 手机 点卡 电话卡 电子器材'>电脑 网络 手机 点卡 电话卡 电子器材</option>"+
                        "<option value='医疗保健 风水开运 教会'>医疗保健 风水开运 教会</option>"+
                        "<option value='语言学校 驾校 各种学校'></option>"+
                        "<option value='其它'></option>"
                    );
                    if(!localStorage.informationBusinessCatagory) {
                        var data =  {
                            index: sessionStorage.index,
                            tags: "",
                            skip: 0,
                            limit: 15
                        };
                        sendAjax('/app_information_catagory', data, function(shops){
                            $('.information_catagory_floatingBarsG').hide();
                            $.each(shops, insertInformationCatagory);
                            localStorage.informationBusinessCatagory = JSON.stringify(shops);
                        }, function(jqXHR, textStatus, errorThrown){
                            $('.information_catagory_floatingBarsG').hide();
                            showError('#information_catagory_page','网络错误！连接失败！ 请重试!');
                        });
                    } else {
                        var shops = JSON.parse(localStorage.informationBusinessCatagory);
                        $('.information_catagory_floatingBarsG').hide();
                        $.each(shops, insertInformationCatagory);
                    }                    
                } else if(sessionStorage.index=="ticket") {
                    $('#key_selector').html('').append(
                        "<option value='' selected='selected'>全部分类</option>"+
                        "<option value='各地机票'>各地机票</option>"+
                        "<option value='紧急出票 24小时出票'>紧急出票 24小时出票</option>"+
                        "<option value='旅行社业务 地接业务'>旅行社业务 地接业务</option>"+
                        "<option value='代办签证'>代办签证</option>"
                    );
                    if(!localStorage.informationTicketCatagory) {
                        var data =  {
                            index: sessionStorage.index,
                            tags: "",
                            skip: 0,
                            limit: 15
                        };
                        sendAjax('/app_information_catagory', data, function(shops){
                            $('.information_catagory_floatingBarsG').hide();
                            $.each(shops, insertInformationCatagory);
                            localStorage.informationTicketCatagory = JSON.stringify(shops);
                        }, function(jqXHR, textStatus, errorThrown){
                            $('.information_catagory_floatingBarsG').hide();
                            showError('#information_catagory_page','网络错误！连接失败！ 请重试!');
                        });
                    } else {
                        var shops = JSON.parse(localStorage.informationTicketCatagory);
                        $('.information_catagory_floatingBarsG').hide();
                        $.each(shops, insertInformationCatagory);
                    }                    
                } else {
                    if(!localStorage.informationLawCatagory) {
                        $('#key_selector').html('').append(
                        "<option value='' selected='selected'>全部分类</option>"+
                        "<option value='法律业务'>法律业务</option>"+
                        "<option value='会计业务'>会计业务</option>"+
                        "<option value='其它'>其它</option"
                    );
                        var data =  {
                            index: sessionStorage.index,
                            tags: "",
                            skip: 0,
                            limit: 15
                        };
                        sendAjax('/app_information_catagory', data, function(shops){
                            $('.information_catagory_floatingBarsG').hide();
                            $.each(shops, insertInformationCatagory);
                            localStorage.informationLawCatagory = JSON.stringify(shops);
                        }, function(jqXHR, textStatus, errorThrown){
                            $('.information_catagory_floatingBarsG').hide();
                            showError('#information_catagory_page','网络错误！连接失败！ 请重试!');
                        });
                    } else {
                        var shops = JSON.parse(localStorage.informationLawCatagory);
                        $('.information_catagory_floatingBarsG').hide();
                        $.each(shops, insertInformationCatagory);
                    }
                }
                $('#information_catagory').on('click', '.information_list a', function(){
                    sessionStorage.uid = $(this).parent('div.information_list').attr('id');
                });
                $('#key_selector').change(function(){
                    mKey=$('#key_selector').val();
                    $('#information_catagory').html("");
                    $('.information_catagory_floatingBarsG').show();
                    var data = {
                        index: sessionStorage.index,
                        tags: mKey,
                        skip: 0,
                        limit: 15
                    };
                    sendAjax('/app_information_catagory', data, function(shops){
                        $.each(shops, insertInformationCatagory);
                        $('.information_catagory_floatingBarsG').hide();
                        mSkip=15;
                    },function(jqXHR, textStatus, errorThrown){
                        $('.information_catagory_floatingBarsG').hide();
                        mSkip=15;
                    });
                });
                $('#search_bar').submit(function(e){
                    mKey=$('#search_input').val();
                    $('#information_catagory').html("");
                    $('.information_catagory_floatingBarsG').show();
                    var data = {
                        index: sessionStorage.index,
                        tags: mKey,
                        skip: 0,
                        limit: 15
                    };
                    sendAjax('/app_information_catagory', data, function(shops){
                        $.each(shops, insertInformationCatagory);
                        $('.information_catagory_floatingBarsG').hide();
                        mSkip=15;
                    },function(jqXHR, textStatus, errorThrown){
                        $('.information_catagory_floatingBarsG').hide();
                        mSkip=15;
                    });
                    return false;
                    e.preventDefault();
                });
                $('#search_bar').change(function(){
                    if($('#search_input').val()=="") {
                        mKey="";
                        $('#information_catagory').html("");
                        $('.information_catagory_floatingBarsG').show();
                        var data = {
                            index: sessionStorage.index,
                            tags: mKey,
                            skip: 0,
                            limit: 15
                        };
                        sendAjax('/app_information_catagory', data, function(shops){
                            $.each(shops, insertInformationCatagory);
                            $('.information_catagory_floatingBarsG').hide();
                            mSkip=15;
                        },function(jqXHR, textStatus, errorThrown){
                            $('.information_catagory_floatingBarsG').hide();
                            mSkip=15;
                        });
                    }
                });
            }
            
            function insertInformationCatagory(key, shop) {
                var imgstring="", classstring="";
                if (shop.previmg.length==0){
                    imgstring = "resource/img/information_img/information_box.png";
                } else {
                    imgstring = "data:image/jpg;base64,"+shop.previmg;
                }
                if(key % 3 ==0) {
                    classstring = "ui-block-a";
                } else if(key % 3 ==1) {
                    classstring = "ui-block-b";
                } else if(key % 3 ==2) {
                    classstring = "ui-block-c";
                }
                $('#information_catagory').append("<div class='"+classstring+"'>"+
                    "<div class='information_list' id='"+shop.uid+"'>"+
                    "<a href='information_details.html' data-transition='slide'>"+
                    "<img alt='img' src='"+imgstring+"'></img>"+
                    "<p>"+shop.prevtext+"</p>"+
                    "<pre>"+shop.prevtext2+"</pre>"+
                    "</a>"+
                    "</div>"+
                    "</div>");
            }

            function gotPullDownData(event, mIscroll) {
                var data =  {
                    index: sessionStorage.index,
                    tags: "",
                    skip: 0,
                    limit: 15
                };
                sendAjax('/app_information_catagory', data, function(shops){
                    $('#information_catagory').html("");
                    $.each(shops, insertInformationCatagory);
                    if(sessionStorage.index=="find_job"){
                        localStorage.informationFindJobCatagory = JSON.stringify(shops);
                    } else if(sessionStorage.index=="find_house") {
                        localStorage.informationFindHouseCatagory = JSON.stringify(shops);
                    } else if(sessionStorage.index=="move_house") {
                        localStorage.informationMoveHouseCatagory = JSON.stringify(shops);
                    } else if(sessionStorage.index=="business") {
                        localStorage.informationBusinessCatagory = JSON.stringify(shops);
                    } else if(sessionStorage.index=="ticket") {
                        localStorage.informationTicketCatagory = JSON.stringify(shops);
                    } else {
                        localStorage.informationLawCatagory = JSON.stringify(shops);
                    }
                    mIscroll.iscrollview.refresh();
                    mSkip=15;
                }, function(jqXHR, textStatus, errorThrown){
                    showError('#information_catagory_page','网络错误！连接失败！ 请重试!');
                });
            }

            function gotPullUpData(event, mIscroll) {
                if(!pullUpflag) {
                    pullUpflag=true;
                    var data = {
                        index: sessionStorage.index,
                        tags: mKey,
                        skip: mSkip,
                        limit: mLimit
                    };
                    sendAjax('/app_information_catagory', data, function(shops){
                        mSkip+=mLimit;
                        pullUpflag=false;
                        $.each(shops, insertInformationCatagory);
                        iscrollview = mIscroll.iscrollview,
                        iscrollview.refresh(null, null, $.proxy(function (iscrollview) { 
                            this.scrollToElement(lastItemSelector, 400); 
                        }, iscrollview) ); 
                    },function(jqXHR, textStatus, errorThrown){
                        showError('#information_catagory_page','网络错误！连接失败！ 请重试!');
                    });

                }
            }

            function onPullDown (event, data) { 
                gotPullDownData(event, data); 
            }    

            function onPullUp (event, data) { 
                gotPullUpData(event, data); 
            }

        </script>
    </div>
</body>
</html>